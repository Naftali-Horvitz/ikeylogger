<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>מרכז ניהול מחשבים</title>
  <style>
    /* -----------------------------
       בסיס + משתני ערכת נושא
       ----------------------------- */
    :root {
      --bg: #f7f7f8;
      --panel: #ffffff;
      --text: #0f172a;
      --muted: #6b7280;
      --border: #e5e7eb;
      --accent: #2563eb;
      --accent-2: #22c55e;
      --danger: #ef4444;
      --warn: #f59e0b;
      --radius: 16px;
      --shadow: 0 10px 25px rgba(2, 6, 23, 0.06);
      --focus: 0 0 0 3px rgba(37,99,235,.2);
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }

    /* ערכת נושא מינימליסטית */
    .theme-minimal {
      --bg: #ffffff;
      --panel: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --accent: #111827;  /* שחור שקט */
      --accent-2: #10b981; /* ירוק עדין */
      --radius: 8px;
      --shadow: 0 1px 0 rgba(0,0,0,.04);
      --focus: 0 0 0 2px rgba(17,24,39,.2);
    }

    /* ערכת נושא מודרנית (ברירת מחדל) */
    .theme-modern {
      --bg: #f7f7f8;
      --panel: #ffffff;
      --text: #0f172a;
      --muted: #6b7280;
      --border: #e5e7eb;
      --accent: #2563eb; /* כחול */
      --accent-2: #22c55e; /* ירוק */
      --radius: 16px;
      --shadow: 0 10px 25px rgba(2, 6, 23, 0.06);
      --focus: 0 0 0 3px rgba(37,99,235,.2);
    }

    /* ערכת נושא כהה-ניאון */
    .theme-neon {
      --bg: #0b0f14;
      --panel: #0f1720;
      --text: #e5f4ff;
      --muted: #94a3b8;
      --border: #1f2a37;
      --accent: #7df9ff; /* תכלת ניאון */
      --accent-2: #a3ff12; /* ירוק ניאון */
      --danger: #ff6b6b;
      --warn: #ffd166;
      --radius: 18px;
      --shadow: 0 0 0 rgba(0,0,0,0);
      --focus: 0 0 0 3px rgba(125,249,255,.25);
    }

    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--text); font-family: var(--font);
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }

    .container { max-width: 1200px; margin-inline: auto; padding: 24px; }

    header.appbar {
      position: sticky; top: 0; z-index: 20;
      backdrop-filter: saturate(180%) blur(8px);
      background: color-mix(in oklab, var(--panel) 80%, transparent);
      border-bottom: 1px solid var(--border);
    }

    .appbar-inner { display: flex; gap: 16px; align-items: center; justify-content: space-between; padding: 12px 24px; }
    .brand { display: flex; align-items: center; gap: 12px; }
    .logo { width: 28px; height: 28px; border-radius: 8px; background: linear-gradient(135deg, var(--accent), var(--accent-2)); box-shadow: var(--shadow); }
    .brand h1 { font-size: 18px; margin: 0; font-weight: 700; }

    nav.topnav { display: flex; gap: 8px; flex-wrap: wrap; }
    .tablink {
      appearance: none; border: 1px solid var(--border); background: var(--panel); color: var(--text);
      padding: 8px 14px; border-radius: 999px; cursor: pointer; transition: all .2s ease; font-weight: 600;
    }
    .tablink:hover { transform: translateY(-1px); box-shadow: var(--shadow); }
    .tablink[aria-current="page"] { background: color-mix(in oklab, var(--accent) 12%, var(--panel)); border-color: color-mix(in oklab, var(--accent) 40%, var(--border)); }

    .toolbar { display: flex; align-items: center; gap: 10px; }
    .select, .input, .button {
      appearance: none; border: 1px solid var(--border); background: var(--panel); color: var(--text);
      padding: 10px 12px; border-radius: 12px; font-size: 14px; outline: none; transition: box-shadow .2s, border-color .2s;
    }
    .select:focus, .input:focus, .button:focus { box-shadow: var(--focus); border-color: var(--accent); }
    .button { cursor: pointer; font-weight: 700; }
    .button.primary { background: var(--accent); color: #fff; border-color: transparent; }
    .button.ghost { background: transparent; }
    .button.danger { background: var(--danger); color: #fff; border-color: transparent; }
    .button.warn { background: var(--warn); color: #111; border-color: transparent; }

    main { padding: 24px; }
    .page { display: none; }
    .page.active { display: block; }

    /* כרטיסיות ותצוגות */
    .grid { display: grid; gap: 16px; }
    .grid.cols-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .grid.cols-3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
    @media (max-width: 900px) { .grid.cols-3 { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 640px) { .grid.cols-2, .grid.cols-3 { grid-template-columns: 1fr; } }

    .card {
      background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius);
      padding: 16px; box-shadow: var(--shadow);
    }
    .card h3 { margin: 0 0 8px 0; font-size: 16px; }

    .muted { color: var(--muted); }
    .badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 999px; font-size: 12px; border: 1px solid var(--border); background: color-mix(in oklab, var(--panel) 80%, var(--bg)); }
    .badge.success { border-color: color-mix(in oklab, var(--accent-2) 50%, var(--border)); color: color-mix(in oklab, var(--accent-2) 75%, var(--text)); }
    .badge.info { border-color: color-mix(in oklab, var(--accent) 50%, var(--border)); color: color-mix(in oklab, var(--accent) 75%, var(--text)); }
    .badge.warn { border-color: color-mix(in oklab, var(--warn) 50%, var(--border)); color: color-mix(in oklab, var(--warn) 75%, var(--text)); }
    .badge.danger { border-color: color-mix(in oklab, var(--danger) 50%, var(--border)); color: color-mix(in oklab, var(--danger) 75%, var(--text)); }

    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: right; padding: 10px; border-bottom: 1px solid var(--border); }
    th { font-size: 12px; text-transform: uppercase; letter-spacing: .05em; color: var(--muted); }
    tr:hover td { background: color-mix(in oklab, var(--panel) 70%, var(--bg)); }

    .footer { padding: 16px 24px; color: var(--muted); font-size: 12px; border-top: 1px solid var(--border); }

    /* מתג מצב הסוכן */
    .switch { position: relative; width: 54px; height: 30px; background: #d1d5db; border-radius: 999px; transition: background .25s; border: 1px solid var(--border); }
    .switch.on { background: color-mix(in oklab, var(--accent-2) 65%, #d1d5db); }
    .knob { position: absolute; top: 3px; inset-inline-start: 3px; width: 24px; height: 24px; background: #fff; border-radius: 50%; transition: transform .25s; box-shadow: var(--shadow); }
    .switch.on .knob { transform: translateX(-24px); /* RTL: זז שמאלה */ }
    [dir="rtl"] .switch.on .knob { transform: translateX(24px); }

    /* אנימציית טוסט */
    .toast { position: fixed; inset-inline-start: 24px; bottom: 24px; z-index: 50; display: grid; gap: 8px; }
    .toast .item { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 12px 14px; box-shadow: var(--shadow); animation: slideIn .2s ease; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(8px);} to { opacity: 1; transform: translateY(0);} }

    /* דגשים למינימליסטי */
    .theme-minimal .tablink { border-radius: 8px; padding: 6px 10px; font-weight: 600; }
    .theme-minimal .card { box-shadow: none; }
    .theme-minimal header.appbar { background: #fff; }

    /* דגשים לניאון */
    .theme-neon .tablink { background: #0f1720; border-color: #1f2a37; color: var(--text); }
    .theme-neon .tablink[aria-current="page"] { outline: 2px solid color-mix(in oklab, var(--accent) 50%, transparent); }
    .theme-neon .logo { box-shadow: 0 0 20px color-mix(in oklab, var(--accent) 40%, transparent); }
  </style>
</head>
<body class="theme-modern">
  <header class="appbar" role="banner">
    <div class="appbar-inner container">
      <div class="brand" aria-label="כותרת היישום">
        <div class="logo" aria-hidden="true"></div>
        <h1>מרכז ניהול מחשבים</h1>
      </div>
      <nav class="topnav" aria-label="ניווט ראשי">
        <button class="tablink" data-route="#/home">עמוד הבית</button>
        <button class="tablink" data-route="#/logs">לוגים</button>
        <button class="tablink" data-route="#/alerts">התראות</button>
        <button class="tablink" data-route="#/agent">ניהול הסוכן</button>
      </nav>
      <div class="toolbar">
        <label for="themeSelect" class="muted" style="font-weight:600">עיצוב:</label>
        <select id="themeSelect" class="select" aria-label="בחירת עיצוב">
          <option value="theme-minimal">מינימליסטי</option>
          <option value="theme-modern" selected>מודרני</option>
          <option value="theme-neon">כהה · ניאון</option>
        </select>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- עמוד הבית -->
    <section id="page-home" class="page" data-route="home">
      <div class="grid cols-3">
        <div class="card">
          <h3>מחשבים במערכת</h3>
          <p class="muted" id="computerCount">—</p>
          <div class="toolbar" style="margin-block:8px">
            <input id="searchComputers" class="input" placeholder="חיפוש מחשב לפי שם…" />
            <button class="button ghost" id="btnRefreshHome">רענון</button>
          </div>
          <div id="computerList" class="grid cols-2" aria-live="polite"></div>
        </div>
        <div class="card">
          <h3>סטטיסטיקות זריזות</h3>
          <ul class="muted" id="quickStats" style="line-height:1.9"></ul>
        </div>
        <div class="card">
          <h3>התראה אחרונה</h3>
          <div id="latestAlert">—</div>
        </div>
      </div>
    </section>

    <!-- לוגים -->
    <section id="page-logs" class="page" data-route="logs">
      <div class="card">
        <div class="toolbar" style="justify-content: space-between; gap: 12px; flex-wrap: wrap;">
          <div class="toolbar" style="gap:8px">
            <input id="searchLogs" class="input" placeholder="סינון לפי טקסט או מחשב…" />
            <select id="levelFilter" class="select">
              <option value="">כל הרמות</option>
              <option value="INFO">INFO</option>
              <option value="WARN">WARN</option>
              <option value="ERROR">ERROR</option>
            </select>
          </div>
          <div class="toolbar" style="gap:8px">
            <button class="button" id="btnExportCsv">ייצוא CSV</button>
            <button class="button ghost" id="btnAddLog">הוסף לוג דוגמה</button>
          </div>
        </div>
        <div style="overflow:auto; max-height: 55vh; margin-top: 8px; border:1px solid var(--border); border-radius: 12px;">
          <table aria-label="טבלת לוגים">
            <thead>
              <tr>
                <th>זמן</th>
                <th>מחשב</th>
                <th>רמה</th>
                <th>הודעה</th>
              </tr>
            </thead>
            <tbody id="logsTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- התראות -->
    <section id="page-alerts" class="page" data-route="alerts">
      <div class="card">
        <div class="toolbar" style="justify-content: space-between; gap: 12px; flex-wrap: wrap;">
          <div class="toolbar">
            <select id="severityFilter" class="select">
              <option value="">כל החומרות</option>
              <option value="low">נמוכה</option>
              <option value="medium">בינונית</option>
              <option value="high">גבוהה</option>
            </select>
            <button class="button ghost" id="btnAddAlert">צור התראת דוגמה</button>
          </div>
          <div class="toolbar">
            <button class="button" id="btnResolveAll">סמן כולן כטופלו</button>
          </div>
        </div>
        <div id="alertsList" class="grid cols-2" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- ניהול הסוכן -->
    <section id="page-agent" class="page" data-route="agent">
      <div class="grid cols-2">
        <div class="card">
          <h3>מצב הסוכן</h3>
          <div class="toolbar" style="justify-content: space-between;">
            <div class="badge info">גרסה: <span id="agentVersion">1.3.2</span></div>
            <div class="toolbar" style="gap: 12px; align-items: center;">
              <span class="muted" id="agentStateLabel">מופעל</span>
              <div id="agentSwitch" class="switch on" role="switch" aria-checked="true" tabindex="0" aria-label="הפעל/כיבוי סוכן"><div class="knob"></div></div>
            </div>
          </div>
          <div class="toolbar" style="margin-top: 12px; gap: 8px; flex-wrap: wrap;">
            <button class="button warn" id="btnCheckUpdates">בדיקת עדכון</button>
            <button class="button primary" id="btnInstallUpdate" disabled>התקן עדכון</button>
            <button class="button ghost" id="btnPing">בדיקת תקשורת</button>
          </div>
        </div>
        <div class="card">
          <h3>הגדרות</h3>
          <form id="agentForm" class="grid" style="gap:10px">
            <label>
              <div class="muted" style="font-weight:600">שרת רישום</div>
              <input class="input" name="endpoint" placeholder="https://logs.example.local" required />
            </label>
            <label>
              <div class="muted" style="font-weight:600">רמת לוג</div>
              <select class="select" name="level">
                <option>INFO</option>
                <option>WARN</option>
                <option>ERROR</option>
                <option>DEBUG</option>
              </select>
            </label>
            <label>
              <div class="muted" style="font-weight:600">מרווח ניטור (שניות)</div>
              <input class="input" name="interval" type="number" min="1" value="30" required />
            </label>
            <div class="toolbar" style="margin-top: 4px; gap:8px">
              <button type="submit" class="button primary">שמור</button>
              <button type="reset" class="button ghost">איפוס</button>
            </div>
          </form>
        </div>
      </div>

      <div class="card" style="margin-top: 16px;">
        <h3>ניהול מחשבים</h3>
        <form id="addComputerForm" class="toolbar" style="gap:8px; flex-wrap: wrap;">
          <input class="input" id="newComputerName" placeholder="הוסף מחשב חדש בשם…" />
          <button class="button" id="btnAddComputer">הוסף</button>
        </form>
      </div>
    </section>
  </main>

  <div class="footer">
    © <span id="year"></span> · דוגמת UI: 4 דפים, 3 עיצובים (מינימליסטי/מודרני/כהה)
  </div>

  <div class="toast" aria-live="polite" aria-atomic="true" id="toast"></div>

  <script>
    // -----------------------------
    // נתוני דוגמה והמצב הכולל
    // -----------------------------
    const state = {
      computers: [
        'PC-IL-DB-01','PC-IL-WEB-12','LAPTOP-OPS-7','SRV-BACKUP-02','QA-VM-03','DEV-WS-014','PC-TLV-SEC-01','SRV-MAIL-01','KIOSK-HALL-2','LAB-NUC-11'
      ],
      logs: [
        { time: new Date(Date.now()-3600_000).toISOString(), host: 'PC-IL-DB-01', level: 'INFO', message: 'DB sync completed' },
        { time: new Date(Date.now()-1800_000).toISOString(), host: 'PC-IL-WEB-12', level: 'WARN', message: 'High CPU usage detected' },
        { time: new Date(Date.now()-900_000).toISOString(), host: 'SRV-BACKUP-02', level: 'ERROR', message: 'Backup job failed' },
        { time: new Date(Date.now()-300_000).toISOString(), host: 'QA-VM-03', level: 'INFO', message: 'Agent heartbeat OK' },
      ],
      alerts: [
        { id: crypto.randomUUID(), severity: 'high', host: 'SRV-BACKUP-02', text: 'כשל רציני במשימת גיבוי', resolved: false, time: Date.now()-920_000 },
        { id: crypto.randomUUID(), severity: 'medium', host: 'PC-IL-WEB-12', text: 'צריכת CPU חריגה ב-10 דקות האחרונות', resolved: false, time: Date.now()-520_000 },
        { id: crypto.randomUUID(), severity: 'low', host: 'QA-VM-03', text: 'גרסת סוכן ישנה', resolved: true, time: Date.now()-3_600_000 },
      ],
      agent: { running: true, version: '1.3.2', pendingVersion: null }
    };

    // כלים קטנים
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    const fmtTime = iso => new Date(iso).toLocaleString('he-IL');
    const toast = (msg) => {
      const t = document.createElement('div');
      t.className = 'item';
      t.textContent = msg;
      $('#toast').appendChild(t);
      setTimeout(()=> t.remove(), 3500);
    };

    // -----------------------------
    // ניווט (SPA)  #/home | #/logs | #/alerts | #/agent
    // -----------------------------
    function setActiveRoute(hash){
      const route = (hash || '#/home').replace('#/','');
      $$('.page').forEach(p => p.classList.toggle('active', p.dataset.route===route));
      $$('.tablink').forEach(b => b.setAttribute('aria-current', b.dataset.route === '#/'+route ? 'page' : 'false'));
      document.title = `מרכז ניהול מחשבים · ${routeLabel(route)}`;
      switch(route){
        case 'home': renderHome(); break;
        case 'logs': renderLogs(); break;
        case 'alerts': renderAlerts(); break;
        case 'agent': renderAgent(); break;
      }
    }
    function routeLabel(route){
      return ({home:'עמוד הבית', logs:'לוגים', alerts:'התראות', agent:'ניהול הסוכן'})[route] || '';
    }

    window.addEventListener('hashchange', () => setActiveRoute(location.hash));

    // כפתורי ניווט
    $$('.tablink').forEach(btn => btn.addEventListener('click', () => {
      location.hash = btn.dataset.route;
    }));

    // -----------------------------
    // עיצובים (3 סוגים): מינימליסטי / מודרני / כהה-ניאון
    // -----------------------------
    const themeSelect = $('#themeSelect');
    function applyTheme(theme){
      document.body.classList.remove('theme-minimal','theme-modern','theme-neon');
      document.body.classList.add(theme);
      localStorage.setItem('ui-theme', theme);
    }
    themeSelect.addEventListener('change', e => applyTheme(e.target.value));

    // שחזור ערכת נושא מהאחסון
    const savedTheme = localStorage.getItem('ui-theme') || 'theme-modern';
    themeSelect.value = savedTheme;
    applyTheme(savedTheme);

    // -----------------------------
    // רינדור עמוד הבית
    // -----------------------------
    function renderHome(){
      $('#year').textContent = new Date().getFullYear();
      const list = $('#computerList');
      const term = ($('#searchComputers').value || '').toLowerCase().trim();
      const rows = state.computers
        .filter(n => !term || n.toLowerCase().includes(term))
        .sort((a,b)=> a.localeCompare(b,'he'));
      list.innerHTML = '';
      rows.forEach(name => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<h3>${name}</h3>
          <div class="muted">מצב: ${randomStatusBadge()}</div>`;
        list.appendChild(card);
      });
      $('#computerCount').textContent = `${rows.length} מחשבים מוצגים`;

      // סטטיסטיקות קצרות
      const stats = $('#quickStats');
      const online = Math.floor(rows.length * 0.86);
      const updates = Math.max(0, Math.floor(rows.length * 0.12) - 1);
      stats.innerHTML = `
        <li>מחוברים: <strong>${online}</strong></li>
        <li>נדרשת התקנת עדכונים: <strong>${updates}</strong></li>
        <li>שגיאות יומיות אחרונות: <strong>${state.logs.filter(l=>l.level==='ERROR').length}</strong></li>
      `;

      // התראה אחרונה
      const latest = [...state.alerts].sort((a,b)=> b.time - a.time)[0];
      $('#latestAlert').innerHTML = latest
        ? `<div class="badge ${sevClass(latest.severity)}">חומרה: ${sevLabel(latest.severity)}</div>
           <p style="margin:.5rem 0 0 0"><strong>${latest.host}</strong>: ${latest.text}</p>
           <div class="muted">לפני ${(Math.round((Date.now()-latest.time)/60000))} דק׳</div>`
        : '<span class="muted">אין התראות</span>';
    }

    function randomStatusBadge(){
      const statuses = [
        ['זמין','success'], ['תחזוקה','warn'], ['מנותק','danger'], ['פעיל','info']
      ];
      const [label, cls] = statuses[Math.floor(Math.random()*statuses.length)];
      return `<span class="badge ${cls}">${label}</span>`;
    }

    // -----------------------------
    // רינדור לוגים
    // -----------------------------
    function renderLogs(){
      const q = ($('#searchLogs').value||'').toLowerCase().trim();
      const lvl = $('#levelFilter').value;
      const rows = state.logs.filter(l => (!lvl || l.level===lvl) && (!q || l.host.toLowerCase().includes(q) || l.message.toLowerCase().includes(q)) )
                             .sort((a,b)=> new Date(b.time)-new Date(a.time));
      const tbody = $('#logsTable');
      tbody.innerHTML = '';
      rows.forEach(l => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="muted">${fmtTime(l.time)}</td>
                        <td><strong>${l.host}</strong></td>
                        <td><span class="badge ${levelClass(l.level)}">${l.level}</span></td>
                        <td>${escapeHtml(l.message)}</td>`;
        tbody.appendChild(tr);
      });
    }

    function levelClass(level){
      return level==='ERROR' ? 'danger' : level==='WARN' ? 'warn' : 'info';
    }

    // -----------------------------
    // רינדור התראות
    // -----------------------------
    function renderAlerts(){
      const sev = $('#severityFilter').value;
      const list = $('#alertsList');
      const rows = state.alerts.filter(a => (!sev || a.severity===sev))
                               .sort((a,b)=> Number(a.resolved)-Number(b.resolved) || b.time - a.time);
      list.innerHTML = '';
      if(rows.length===0){
        const empty = document.createElement('div');
        empty.className = 'muted';
        empty.textContent = 'אין התראות תואמות.';
        list.appendChild(empty);
        return;
      }
      rows.forEach(a => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="toolbar" style="justify-content: space-between; align-items: start; gap: 8px;">
            <div>
              <div class="badge ${sevClass(a.severity)}">${sevLabel(a.severity)}</div>
              <h3 style="margin-top:6px">${a.host}</h3>
              <div class="muted">${new Date(a.time).toLocaleString('he-IL')}</div>
            </div>
            <div class="toolbar" style="gap:8px">
              <button class="button ${a.resolved ? 'ghost' : 'primary'}" data-action="resolve" data-id="${a.id}" ${a.resolved ? 'disabled' : ''}>סמן כטופל</button>
              <button class="button ghost" data-action="remove" data-id="${a.id}">הסר</button>
            </div>
          </div>
          <p style="margin: 8px 0 0 0">${escapeHtml(a.text)}</p>
        `;
        list.appendChild(card);
      });
    }

    function sevLabel(s){ return s==='high'?'גבוהה': s==='medium'?'בינונית':'נמוכה'; }
    function sevClass(s){ return s==='high'?'danger': s==='medium'?'warn':'info'; }

    // -----------------------------
    // רינדור ניהול הסוכן
    // -----------------------------
    function renderAgent(){
      $('#agentVersion').textContent = state.agent.version;
      const on = state.agent.running;
      const sw = $('#agentSwitch');
      sw.classList.toggle('on', on);
      sw.setAttribute('aria-checked', String(on));
      $('#agentStateLabel').textContent = on ? 'מופעל' : 'כבוי';
    }

    // -----------------------------
    // אירועים וטפסים
    // -----------------------------
    $('#searchComputers').addEventListener('input', renderHome);
    $('#btnRefreshHome').addEventListener('click', () => { toast('הרשימה עודכנה'); renderHome(); });

    $('#searchLogs').addEventListener('input', renderLogs);
    $('#levelFilter').addEventListener('change', renderLogs);
    $('#btnAddLog').addEventListener('click', () => {
      const sample = { time: new Date().toISOString(), host: sampleFrom(state.computers), level: sampleFrom(['INFO','WARN','ERROR']), message: sampleFrom([
        'User logged in','Service restarted','Disk nearing capacity','Backup job completed','High memory usage','Package updated']) };
      state.logs.unshift(sample);
      renderLogs();
      toast('לוג חדש נוסף');
    });

    $('#btnExportCsv').addEventListener('click', () => {
      const rows = [['time','host','level','message'], ...state.logs.map(l=>[l.time,l.host,l.level,l.message.replaceAll('\n',' ')])];
      const csv = rows.map(r=> r.map(x => '"'+String(x).replaceAll('"','""')+'"').join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'logs.csv'; a.click();
      setTimeout(()=> URL.revokeObjectURL(url), 0);
    });

    $('#severityFilter').addEventListener('change', renderAlerts);
    $('#btnAddAlert').addEventListener('click', () => {
      const a = { id: crypto.randomUUID(), severity: sampleFrom(['low','medium','high']), host: sampleFrom(state.computers), text: sampleFrom([
        'כשל אימות','ניסיון חיבור לא מורשה','עדכון נדרש','שירות הפסיק לפעול','קובץ לוג חסר']), resolved: false, time: Date.now() };
      state.alerts.unshift(a); renderAlerts(); toast('התראה חדשה נוצרה');
    });

    $('#btnResolveAll').addEventListener('click', () => {
      state.alerts.forEach(a => a.resolved = true); renderAlerts(); toast('כל ההתראות סומנו כטופלו');
    });

    $('#alertsList').addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]'); if(!btn) return;
      const id = btn.dataset.id; const action = btn.dataset.action;
      const idx = state.alerts.findIndex(a => a.id===id); if(idx<0) return;
      if(action==='resolve'){ state.alerts[idx].resolved = true; toast('התראה סומנה כטופלה'); }
      if(action==='remove'){ state.alerts.splice(idx,1); toast('התראה הוסרה'); }
      renderAlerts();
    });

    $('#agentSwitch').addEventListener('click', toggleAgent);
    $('#agentSwitch').addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggleAgent(); } });

    function toggleAgent(){
      state.agent.running = !state.agent.running; renderAgent();
      toast(state.agent.running?'הסוכן הופעל':'הסוכן כובה');
    }

    let latestFoundVersion = null;
    $('#btnCheckUpdates').addEventListener('click', () => {
      // סימולציה למציאת גרסה חדשה לעיתים
      if(Math.random() > 0.4){
        latestFoundVersion = bumpMinor(state.agent.version);
        state.agent.pendingVersion = latestFoundVersion;
        $('#btnInstallUpdate').disabled = false;
        toast(`נמצאה גרסה חדשה ${latestFoundVersion}`);
      } else {
        $('#btnInstallUpdate').disabled = true; state.agent.pendingVersion = null;
        toast('לא נמצאו עדכונים');
      }
    });

    $('#btnInstallUpdate').addEventListener('click', () => {
      if(!state.agent.pendingVersion) return;
      state.agent.version = state.agent.pendingVersion;
      state.agent.pendingVersion = null;
      $('#btnInstallUpdate').disabled = true;
      renderAgent(); toast('העדכון הותקן');
    });

    $('#btnPing').addEventListener('click', () => {
      toast('תקשורת תקינה (pong)');
    });

    $('#agentForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target).entries());
      if(!/^https?:\/\//.test(data.endpoint)){ toast('כתובת שרת אינה תקינה'); return; }
      const interval = Number(data.interval);
      if(!Number.isFinite(interval) || interval < 1){ toast('מרווח ניטור אינו תקין'); return; }
      toast('הגדרות נשמרו');
    });

    $('#addComputerForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const name = ($('#newComputerName').value||'').trim();
      if(!name){ toast('יש להזין שם מחשב'); return; }
      if(state.computers.includes(name)){ toast('שם זה כבר קיים'); return; }
      state.computers.push(name); $('#newComputerName').value='';
      toast('המחשב נוסף'); renderHome();
    });

    // -----------------------------
    // עזר
    // -----------------------------
    function sampleFrom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function bumpMinor(v){ const [maj, min, patch] = v.split('.').map(n=>+n); return `${maj}.${min+1}.${patch}`; }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

    // -----------------------------
    // אתחול
    // -----------------------------
    setActiveRoute(location.hash || '#/home');
  </script>
</body>
</html>
